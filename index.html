<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VGR Konst Sök</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <meta name="theme-color" content="#0077cc" />

  <!-- QR-bibliotek -->
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>

  <style>
    :root{--brand:#0077cc;--brand-dark:#005a9e;--bg:#f7f9fc}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:#222}
    header{padding:18px 16px;text-align:center}
    header h1{margin:0;color:#004a99;font-size:1.25rem}

    .wrap{max-width:1000px;margin:0 auto;padding:0 12px 28px}

    /* Sökfält */
    #searchForm{
      display:grid;grid-template-columns:repeat(4,minmax(170px,1fr));
      gap:10px 12px;background:#fff;padding:12px;border-radius:12px;
      box-shadow:0 8px 24px rgba(0,0,0,.06)
    }
    #searchForm input[type="search"], #searchForm select{
      padding:.7rem .8rem;border:1.5px solid #d0d7de;border-radius:10px;font-size:1rem;background:#fff;
      transition:border-color .2s,box-shadow .2s
    }
    #searchForm input[type="search"]::placeholder{color:#7a8694}
    #searchForm input[type="search"]:focus, #searchForm select:focus{
      outline:none;border-color:var(--brand);box-shadow:0 0 0 4px rgba(0,119,204,.12)
    }
    .actions{display:flex;gap:10px;align-items:stretch}
    button{
      border:none;border-radius:10px;padding:.8rem 1.1rem;font-weight:600;cursor:pointer;
      box-shadow:0 6px 16px rgba(0,0,0,.08)
    }
    #searchBtn{background:var(--brand);color:#fff}
    #searchBtn:hover{background:var(--brand-dark)}
    #clearBtn{background:#e8eef5;color:#123}
    #clearBtn:hover{background:#dbe7f3}

    /* Totaler */
    #totalCount{margin-top:10px;font-size:.95rem;color:#444}

    /* Kortlayout */
    .cards{margin-top:14px;display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .card{
      background:#fff;border-radius:14px;padding:14px 14px;
      box-shadow:0 8px 22px rgba(0,0,0,.06);
      display:flex;flex-direction:column;gap:8px
    }
    .kv{display:grid;grid-template-columns:110px 1fr;gap:6px 10px;align-items:start}
    .k{color:#5b6b7a;font-size:.9rem}
    .v{font-weight:600}
    .empty{margin-top:16px;color:#566;text-align:center}

    /* Urval/knapp-styles */
    .card.selected { outline: 2px solid var(--brand); box-shadow: 0 8px 22px rgba(0,119,204,.18); }
    .card .add-btn { align-self: flex-start; padding:6px 10px; border:none; border-radius:8px; cursor:pointer; font-weight:600; background:#e8eef5; color:#123; }
    .card.selected .add-btn { background:#d2ebff; color:#004a99; }
    .note-line{ font-size:.9rem; color:#334; background:#f3f7fc; padding:6px 8px; border-radius:8px; }

    /* Skylt-knapp särskild ton */
    .skylt-btn { background:#f0f7ff; color:#034; }

    /* Expanderbar urvalslista */
    .sel-list{
      margin-top:8px; display:flex; flex-wrap:wrap; gap:6px;
      max-height:180px; overflow:auto; padding:6px;
      background:#fff; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,.06)
    }
    .sel-item{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 6px; border-radius:999px; background:#eef4fb; font-weight:600; font-size:.85rem;
    }
    .sel-item button{ border:none; background:transparent; cursor:pointer; font-weight:700; line-height:1; font-size:.9rem; }
    .sel-item button:hover{ opacity:.8 }

    /* Mindre knappar i urvalspanelen */
    #selectionBar button { padding:4px 10px; font-size:0.85rem; border-radius:6px; box-shadow:none; }

    /* Mobilanpassning */
    @media (max-width: 900px){ #searchForm{grid-template-columns:repeat(2,1fr)} .cards{grid-template-columns:repeat(2,1fr)} }
    @media (max-width: 560px){ header h1{font-size:1.1rem} #searchForm{grid-template-columns:1fr} .actions{flex-direction:column} #searchBtn,#clearBtn{width:100%} .cards{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header><h1>VGR öppna konstdata – sök</h1></header>
  <div class="wrap">
    <!-- Formulär -->
    <form id="searchForm" aria-label="Sök i datasetet">
      <input type="search" id="creatorInput" placeholder="konstnär" autocomplete="off" />
      <input type="search" id="titleInput" placeholder="titel" autocomplete="off" />
      <input type="search" id="createdInput" placeholder="framställningsår" autocomplete="off" />
      <select id="artformSelect"><option value="">konsttyp (alla)</option></select>
      <select id="artmediumSelect"><option value="">teknik (alla)</option></select>
      <input type="search" id="idInput" placeholder="vg-nummer" autocomplete="off" />
      <input type="search" id="olderIdInput" placeholder="äldre id" autocomplete="off" />
      <div class="actions">
        <button id="searchBtn" type="submit">Sök</button>
        <button id="clearBtn" type="button">Rensa</button>
      </div>
    </form>

    <!-- Totaler + urvalspanel -->
    <div id="totalCount"></div>
    <div id="selectionBar" style="display:flex; gap:8px; align-items:center; margin-top:8px;">
      <span id="selectionCount" style="font-size:.95rem; color:#444;">Urval: 0</span>
      <button id="addAllBtn" type="button" style="background:#e8f5e9; color:#2e7d32; font-weight:600; cursor:pointer;">Lägg till alla</button>
      <button id="copyMailSelBtn" type="button" style="background:#0077cc; color:#fff; font-weight:600; cursor:pointer;">Kopiera/Maila urval</button>
      <button id="clearSelBtn" type="button" style="background:#e8eef5; color:#123; font-weight:600; cursor:pointer;">Rensa urval</button>
    </div>

    <!-- Expanderbar urvalslista -->
    <details id="selectionDetails" style="margin-top:6px;">
      <summary style="cursor:pointer; user-select:none;">Visa urval</summary>
      <div id="selectionList" class="sel-list" aria-live="polite"></div>
    </details>

    <div id="cards" class="cards" role="list"></div>
    <div id="empty" class="empty" hidden>Inga resultat.</div>
  </div>

  <script>
    // ======= Konfiguration =======
    const datasetBaseURL = 'https://vgregion.entryscape.net/rowstore/dataset/1802e57a-b25d-4716-8437-9ed648bbae59';
    const BOM_OLDER_ID_KEY = '\\uFEFFolder id';

    const columnsOrder = ["creator","title","created","artform","artmedium","id",BOM_OLDER_ID_KEY];
    const columnsMap = {
      "creator":"Konstnär","title":"Titel","created":"Framställningsår",
      "artform":"Konsttyp","artmedium":"Teknik","id":"VG-nummer",[BOM_OLDER_ID_KEY]:"Äldre id"
    };

    const inputIdMap = {
      "creator":"creatorInput","title":"titleInput","created":"createdInput",
      "artform":"artformSelect","artmedium":"artmediumSelect","id":"idInput",[BOM_OLDER_ID_KEY]:"olderIdInput"
    };

    let allData = [];

    // ======= Dropdown-listor =======
    const ART_FORMS = [
      "Blandteknik","Collage","Emalj","Fotografi","Grafik","Installation","Ljud","Måleri","Objekt",
      "Relief","Rörlig bild","Skulptur","Teckning","Textil","Övrigt"
    ];

    const ART_MEDIA_RAW = [
      "Övrigt","Övrigt","Vävteknik","Väggmålning","Ull","Tusch/Bläck","Tusch","Träsnitt","Trärelief","Trä","Tryck",
      "Torrnål","Textil","Textil","Temporär","Tempera","Teckning","Svartvit","Stengods/flintgods/keramik","Sten","Skulptur",
      "Silkscreen/Serigrafi","Silkscreen","Serigrafi","Rörlig bild","Relief","porslin","Pochoir","Plast","Pastell","Pastell",
      "Olja","Objekt","Måleri","Monotypi","Mixed media","Mezzotint","Metall","Metall","Ljud","Litografi","Linoleum","Krita",
      "Kopparstick","Konsthantverk/Trä","Konsthantverk/Sten","Konsthantverk/Metall","Konsthantverk/Keramik","Konsthantverk/Glas",
      "Kol","Keramikrelief","Gravyr","Grafik","Graffiti","Gouache","Glas","Gipsrelief","Gips","Färg","Fotopolymer/Fotogravyr",
      "Fotografi","Etsning","Emalj","Emalj","Digitalt pigmenttryck","Digitalprint/Giclée","Collografi/Intaglio","Collografi",
      "Collage","collage","Byggnadsintegrerad","Brons","Broderi","Blyerts","Blandteknik","Blandteknik","Blandteknik",
      "Blandteknik","Blandteknik","Blandteknik","Betong","Batik","Applikation","Akvatint","Akvarell","Akryl"
    ];

    function uniqueSorted(list){
      const cleaned = list
        .map(s => (s || '').toString().trim())
        .filter(Boolean)
        .map(s => s === 'collage' ? 'Collage' : s.replace(/\\s+/g,' '));
      const uniq = [...new Set(cleaned)];
      return uniq.sort((a,b) => a.localeCompare(b,'sv'));
    }
    const ART_MEDIA = uniqueSorted(ART_MEDIA_RAW);

    function populateSelect(el, options, labelAll){
      el.innerHTML = \`<option value="">\${labelAll}</option>\`;
      options.forEach(v=>{
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        el.appendChild(opt);
      });
    }

    // ======= Hjälpfunktioner =======
    const removeAccents = (str) => str.normalize("NFD").replace(/\\p{Diacritic}/gu,"").toLowerCase();
    const capitalizeWords = (str) => str.replace(/(^|\\s)\\S/g, c => c.toLocaleUpperCase('sv-SE'));
    const normalizeText = (str) => str.normalize("NFC").trim();
    function normalizeOlderIdInput(input){
      input = normalizeText(input);
      if(!input) return '';
      if(/^\\d+\\s*[a-zA-Z]$/.test(input)){ return input.replace(/\\s*([a-zA-Z])$/,(_,L)=>' '+L.toUpperCase()); }
      const m = input.match(/^(\\d+)([a-zA-Z])$/);
      return m ? m[1] + ' ' + m[2].toUpperCase() : input;
    }
    function cleanDataKeys(dataArray){
      return dataArray.map(item=>{
        const n={}; for(const k in item){ n[k.replace(/^\\uFEFF/,'')] = item[k]; } return n;
      });
    }

    // ======= URL → parametrar (för auto-sök & QR-länk) =======
    function paramsFromURL() {
      const p = new URLSearchParams(location.search);
      const accepted = ["creator","title","created","artform","artmedium","id","older id"];
      const params = {};
      accepted.forEach(k => { if (p.has(k)) params[k] = p.get(k); });
      return params;
    }

    // ****** LIMIT 100 ******
    function buildQuery(params){
      const parts=[];
      for(const key in params){
        if(params[key]){
          let actualKey = key, val = params[key];
          if(key==='older id'||key===BOM_OLDER_ID_KEY){ actualKey=BOM_OLDER_ID_KEY; val=normalizeOlderIdInput(val); }
          if(key==='id'){ val = val.toUpperCase(); }
          parts.push(encodeURIComponent(actualKey)+'='+encodeURIComponent(val));
        }
      }
      return parts.length ? '?'+parts.join('&')+'&_limit=100&_offset=0' : '?_limit=100&_offset=0';
    }

    // ======= Hämtning + lokalt accent-insensitivt filter =======
    async function fetchData(params={}, rawSearch={}){
      const url = datasetBaseURL + buildQuery(params);
      try{
        const res = await fetch(url, {headers:{accept:'application/json'}});
        if(!res.ok) throw new Error(\`HTTP-fel: \${res.status}\`);
        const json = await res.json();
        allData = cleanDataKeys(json.results || []);

        const filterKeys = Object.keys(rawSearch);
        if(filterKeys.length){
          allData = allData.filter(row=>{
            return filterKeys.every(key=>{
              const sv = removeAccents(String(rawSearch[key] ?? ''));
              const rv = removeAccents(String(row[key] ?? ''));
              return rv.includes(sv);
            });
          });
        }
        renderCards(allData);
      }catch(err){
        document.getElementById('cards').innerHTML='';
        document.getElementById('empty').hidden=false;
        document.getElementById('totalCount').textContent = 'Kunde inte hämta data.';
        console.error(err);
        alert('Hämtfel: '+err.message);
      }
    }

    // ======= Urval (med anteckning + datasnapshot) =======
    const SEL_KEY = 'vgr_konst_selection';
    const SEL_LIMIT = 300;

    // selection som objekt: { VGID: { note: string, data: {...} } }
    let selection = (()=>{
      try{
        const raw = localStorage.getItem(SEL_KEY);
        const parsed = raw ? JSON.parse(raw) : null;
        if(Array.isArray(parsed)){
          // Migrera från gammalt Set-format (bara id:n)
          const obj = {};
          parsed.forEach(id=>{ obj[String(id).toUpperCase()] = { note:'', data:null }; });
          localStorage.setItem(SEL_KEY, JSON.stringify(obj));
          return obj;
        }
        return parsed && typeof parsed==='object' ? parsed : {};
      }catch{ return {}; }
    })();

    function saveSelection(){ localStorage.setItem(SEL_KEY, JSON.stringify(selection)); }
    function selectionSize(){ return Object.keys(selection).length; }
    function hasSelection(id){ return !!selection[String(id||'').toUpperCase()]; }
    function isVG(s) { return /^VG\\d+$/i.test(String(s || '')); }

    function promptAndNormalizeNote(def = ''){
      const n = prompt('Anteckning (valfritt):', def ?? '');
      return n === null ? null : String(n).trim();
    }

    function addToSelection(entry, note='') {
      const id = String(entry?.id || entry || '').toUpperCase();
      if (!isVG(id)) return;
      if (!hasSelection(id) && selectionSize() >= SEL_LIMIT) {
        alert(\`Max \${SEL_LIMIT} i urvalet.\`);
        return;
      }
      const olderKey = 'older id';
      const data = entry && typeof entry === 'object' ? {
        creator: entry.creator ?? '',
        title: entry.title ?? '',
        created: entry.created ?? '',
        artform: entry.artform ?? '',
        artmedium: entry.artmedium ?? '',
        [olderKey]: entry[olderKey] ?? entry[BOM_OLDER_ID_KEY] ?? ''
      } : (selection[id]?.data || null);
      selection[id] = { note: note || (selection[id]?.note || ''), data };
      saveSelection();
      updateSelectionUI();
    }

    function removeFromSelection(id) {
      id = String(id || '').toUpperCase();
      if (selection[id]) delete selection[id];
      saveSelection();
      updateSelectionUI();
    }

    function toggleSelection(entry){
      const id = String(entry?.id || entry || '').toUpperCase();
      if (hasSelection(id)) {
        removeFromSelection(id);
      } else {
        const note = promptAndNormalizeNote('');
        if (note === null) return; // avbruten
        addToSelection(entry, note);
      }
    }

    function updateSelectionUI() {
      const el = document.getElementById('selectionCount');
      if (el) el.textContent = \`Urval: \${selectionSize()}\`;

      // Uppdatera knapparnas text i synliga kort + notisrad
      document.querySelectorAll('.card[data-vg]').forEach(card => {
        const id = card.getAttribute('data-vg') || '';
        const btn = card.querySelector('.add-btn');
        if (!btn) return;
        const selected = hasSelection(id);
        const noteTxt = (selection[id]?.note || '').trim();
        btn.textContent = selected ? 'Ta bort från urval' : 'Lägg till i urval';
        btn.setAttribute('aria-pressed', String(selected));
        btn.title = selected && noteTxt ? \`Anteckning: \${noteTxt}\` : (isVG(id) ? \`Lägg till/ta bort \${id} från urval\` : 'Denna rad saknar giltigt VG-nummer');
        card.classList.toggle('selected', selected);

        // liten rad med anteckningen i kortet när valt
        let nl = card.querySelector('.note-line');
        if (selected && noteTxt) {
          if (!nl) {
            nl = document.createElement('div');
            nl.className = 'note-line';
            card.appendChild(nl);
          }
          nl.textContent = \`Anteckning: \${noteTxt}\`;
        } else if (nl) {
          nl.remove();
        }
      });

      // Rita expanderbar lista
      const list = document.getElementById('selectionList');
      if (list) {
        const ids = Object.keys(selection).sort((a,b)=>a.localeCompare(b,'sv',{numeric:true}));
        list.innerHTML = ids.map(id => {
          const raw = (selection[id]?.note || '').trim();
          const has = raw.length > 0;
          const preview = has ? \` — \${raw.split('\\n')[0].slice(0, 60)}\` : '';
          const titleAttr = has
            ? \` title="\${raw.replace(/&/g,'&amp;').replace(/"/g,'&quot;')}"\`
            : '';
          return \`<span class="sel-item" data-id="\${id}"\${titleAttr}>
            \${id}\${has ? ' 📌' : ''}<span style="font-weight:400;opacity:.85;">\${preview}</span>
            <button type="button" data-edit="\${id}" title="Redigera anteckning">✎</button>
            <button type="button" data-remove="\${id}" title="Ta bort \${id}">×</button>
          </span>\`;
        }).join('');

        // Uppdatera summary-text
        const details = document.getElementById('selectionDetails');
        const summary = details?.querySelector('summary');
        if (summary) summary.textContent = selectionSize() ? \`Visa urval (\${selectionSize()})\` : 'Visa urval';
      }
    }

    // ✕/✎ i urvalslistan
    document.getElementById('selectionList')?.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;

      if (btn.dataset.remove) {
        removeFromSelection(btn.dataset.remove);
        return;
      }

      if (btn.dataset.edit) {
        const id = btn.dataset.edit;
        const current = (selection[id]?.note || '').trim();
        const note = promptAndNormalizeNote(current);
        if (note !== null) {
          selection[id] = selection[id] || { note:'', data:null };
          selection[id].note = note;
          saveSelection();
          updateSelectionUI();
        }
      }
    });

    // ======= Export: BYGG TEXT, KOPIERA, MAILA =======
    function buildSelectionText() {
      const ids = Object.keys(selection).sort((a,b)=>a.localeCompare(b,'sv',{numeric:true}));
      if (ids.length === 0) return null;

      const blocks = ids.map(id => {
        const item = selection[id] || {}; const d = item.data || {};
        return [
          \`Konstnär: \${d.creator || ''}\`,
          \`Titel: \${d.title || ''}\`,
          \`Framställningsår: \${d.created || ''}\`,
          \`Konsttyp: \${d.artform || ''}\`,
          \`Teknik: \${d.artmedium || ''}\`,
          \`VG-nummer: \${id}\`,
          \`Äldre id: \${d['older id'] || ''}\`,
          \`Anteckning: \${item.note || ''}\`
        ].join('\\n');
      });
      const quoted = ids.map(id => \`"\${id}"\`).join(', ');
      return blocks.join('\\n\\n') + \`\\n\\n\${quoted}\`;
    }

    async function copySelectionToClipboard() {
      const text = buildSelectionText();
      if (!text) { alert('Urvalet är tomt.'); return false; }
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch (e) {
        console.warn('Clipboard API misslyckades:', e);
        window.prompt('Kopiera manuellt:', text);
        return false;
      }
    }

    function openEmailComposeWith(text) {
      const defaultSubject = \`Urval – VGR konst (\${new Date().toLocaleDateString('sv-SE')})\`;
      const subject = prompt('Ämne för e-posten:', defaultSubject);
      if (subject === null) return; // avbrutet

      const encSubject = encodeURIComponent(subject.trim());
      const encBody = encodeURIComponent(text);

      const outlookUrl = \`ms-outlook://compose?subject=\${encSubject}&body=\${encBody}\`;
      const mailtoUrl  = \`mailto:?subject=\${encSubject}&body=\${encBody}\`;

      let opened = false;
      const timer = setTimeout(() => {
        if (!opened) window.location.href = mailtoUrl;
      }, 700);

      try {
        window.location.href = outlookUrl;
        opened = true;
      } catch (e) {
        clearTimeout(timer);
        window.location.href = mailtoUrl;
      }
    }

    async function copyThenMaybeEmail() {
      const text = buildSelectionText();
      if (!text) { alert('Urvalet är tomt.'); return; }

      const copied = await copySelectionToClipboard();
      const goMail = confirm(copied
        ? 'Urvalet är kopierat. Vill du öppna e-post med urvalet inklistrat?'
        : 'Vill du öppna e-post med urvalet ändå?');
      if (goMail) openEmailComposeWith(text);
      else if (copied) alert('Klart! Urvalet finns i urklipp.');
    }

    // ======= Lägg till alla från aktuell sökning =======
    function addAllFromCurrentSearch() {
      if (!allData || allData.length === 0) {
        alert('Inga resultat att lägga till.');
        return;
      }
      let addedCount = 0;
      for (const row of allData) {
        const vg = (row['id'] || '').toString().toUpperCase();
        if (!isVG(vg)) continue;
        if (hasSelection(vg)) continue;
        if (selectionSize() >= SEL_LIMIT) break;
        addToSelection({ ...row, id: vg }, '');
        addedCount++;
      }
      if (addedCount === 0) {
        alert('Inga nya VG-nummer lades till (antingen redan i urvalet eller urvalet är fullt).');
      } else {
        alert(\`La till \${addedCount} VG-nummer från sökningen i urvalet.\`);
      }
    }

    // ======= Skylt-popup (Arial, 85×54 mm, QR nere till höger, text över, logga under) =======
    function openSkylt(entry) {
      const artist = (entry.creator || '').toString();
      const title  = (entry.title  || '').toString();
      const year   = (entry.created|| '').toString();
      const vg     = (entry.id     || '').toString().toUpperCase();

      if (!/^VG\\d+$/i.test(vg)) {
        alert('Saknar giltigt VG-nummer.');
        return;
      }

      // Länk som QR pekar på (samma sida + id-parameter)
      const base = location.origin + location.pathname;
      const url  = new URL(base);
      url.searchParams.set('id', vg);

      // Skapa QR som data-URL
      let qrDataUrl = '';
      try {
        if (typeof QRious === 'function') {
          const qrCanvas = document.createElement('canvas');
          new QRious({ element: qrCanvas, value: url.toString(), size: 120, level: 'H' });
          qrDataUrl = qrCanvas.toDataURL('image/png');
        }
      } catch (e) {
        console.warn('QR-generering misslyckades:', e);
      }

      // --- LOGO ---
      // OBS! Webbläsare visar inte EPS. Konvertera EPS -> PNG/SVG och peka på filen här:
      const logoSrc = encodeURI('Lång VGR logotyp svart cmyk.png'); // ändra om din fil heter/ligger annorlunda

      const esc = s => (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;');

      const html = `<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Skylt ${vg}</title>
<style>
  @page { size: 85mm 54mm; margin: 4mm; }
  html,body { height:100%; margin:0; }
  body { font-family: Arial, sans-serif; color:#111; }
  .skylt {
    position: relative;
    width:100%; height:100%;
    display:flex; flex-direction:column;
    justify-content:flex-start; gap:6px;
    line-height:1.25;
  }
  .artist { font-size: 1.15rem; font-weight: 700; }
  .title  { font-size: 1.05rem; font-style: italic; }
  .year   { font-size: 1rem; color:#333; }
  .meta   { margin-top: 4px; font-size: .8rem; color:#555; }

  /* QR-container nere till höger med text över och logga under */
  .qr-wrap {
    position: absolute; bottom: 0; right: 0;
    display:flex; flex-direction:column; align-items:center;
    width: 92px;
  }
  .qr-text {
    font-size: 0.65rem;
    text-align:center;
    margin-bottom:2px;
    color:#333;
  }
  .qr {
    width:80px; height:80px; object-fit:contain;
  }
  .qr-fallback {
    width:80px; height:80px;
    display:flex; align-items:center; justify-content:center;
    border:1px solid #ccc;
    font: 700 12px/1 Arial, sans-serif;
    color:#333; background:#fff;
  }
  .logo {
    margin-top:2px;
    width:80px; /* justera vid behov */
    height:auto;
  }

  @media print { .printbtn { display: none; } }
</style>
</head>
<body>
  <div class="skylt">
    <div class="artist">${esc(artist)}</div>
    <div class="title">${esc(title)}</div>
    <div class="year">${esc(year)}</div>
    <div class="meta">VG-nummer: ${esc(vg)}</div>

    <div class="qr-wrap">
      <div class="qr-text">Skanna QR-kod för mer information</div>
      ${qrDataUrl
        ? `<img class="qr" alt="QR-kod" src="${qrDataUrl}">`
        : `<div class="qr-fallback" aria-label="QR-kod saknas">QR</div>`}
      <img class="logo" src="${logoSrc}" alt="VGR logotyp" onerror="this.style.display='none'">
    </div>
  </div>
  <button class="printbtn" onclick="print()">Skriv ut</button>
</body>
</html>`;

      // Öppna popup utan "noopener,noreferrer" och med write-fallback
      const w = window.open('about:blank', '_blank');
      if (!w) { alert('Popup blockerad. Tillåt popup för denna sida.'); return; }

      try {
        w.document.open();
        w.document.write(html);
        w.document.close();
      } catch (e) {
        console.warn('document.write blockerat, använder blob-fallback:', e);
        const blob = new Blob([html], { type: 'text/html' });
        const blobUrl = URL.createObjectURL(blob);
        w.location.replace(blobUrl);
      }
    }

    // ======= Kort-rendering + totaler =======
    function renderCards(data){
      const wrap = document.getElementById('cards');
      const empty = document.getElementById('empty');
      const total = document.getElementById('totalCount');

      wrap.innerHTML='';
      total.textContent='';

      if(!data.length){
        empty.hidden=false;
        total.textContent = 'Inga resultat.';
        updateSelectionUI();
        return;
      }

      empty.hidden=true;
      total.textContent = data.length >= 100 ? 'Totalt ≥100 resultat (visar max 100)' : \`Totalt \${data.length} resultat\`;

      const frag = document.createDocumentFragment();
      data.forEach(row=>{
        const card = document.createElement('div');
        card.className='card';

        // VG-id som uppercase (kan saknas i enstaka rader)
        const vg = (row['id'] || '').toString().toUpperCase();
        if (isVG(vg)) card.setAttribute('data-vg', vg);

        const kv = document.createElement('div');
        kv.className='kv';

        columnsOrder.forEach(col=>{
          const key = col.replace(/^\\uFEFF/,'');
          let val = row[key] ?? '';
          if(key==='id' && typeof val==='string') val = val.toUpperCase();

          const k = document.createElement('div');
          k.className='k';
          k.textContent = columnsMap[col];

          const v = document.createElement('div');
          v.className='v';
          v.textContent = val;

          kv.appendChild(k);
          kv.appendChild(v);
        });

        // Lägg till/ta bort-knapp
        const btn = document.createElement('button');
        btn.className = 'add-btn';
        btn.type = 'button';
        const existingNote = (selection[vg]?.note || '').trim();
        btn.title = isVG(vg)
          ? (existingNote ? \`Anteckning: \${existingNote}\` : \`Lägg till/ta bort \${vg} från urval\`)
          : 'Denna rad saknar giltigt VG-nummer';
        const selected = hasSelection(vg);
        btn.textContent = selected ? 'Ta bort från urval' : 'Lägg till i urval';
        btn.setAttribute('aria-pressed', String(selected));
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          if (!isVG(vg)) {
            alert('Denna rad saknar giltigt VG-nummer.');
            return;
          }
          toggleSelection({ ...row, id: vg });
        });

        // Skylt-knapp
        const skyltBtn = document.createElement('button');
        skyltBtn.type = 'button';
        skyltBtn.textContent = 'Skylt';
        skyltBtn.className = 'add-btn skylt-btn';
        skyltBtn.style.marginTop = '4px';
        skyltBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          openSkylt({ ...row, id: vg });
        });

        card.appendChild(kv);
        card.appendChild(btn);
        card.appendChild(skyltBtn);

        if (selected) card.classList.add('selected');

        frag.appendChild(card);
      });

      wrap.appendChild(frag);
      updateSelectionUI();
    }

    // ======= Händelser =======
    document.getElementById('searchForm').addEventListener('submit', e=>{
      e.preventDefault();
      const params={}, raw={};
      for(const key in columnsMap){
        const cleanKey = key.replace(/^\\uFEFF/,'');
        const el = document.getElementById(inputIdMap[key]);
        if(el){
          let val = normalizeText(el.value);
          if(val){
            if(cleanKey==='creator') val = capitalizeWords(val);
            if(cleanKey==='older id') val = normalizeOlderIdInput(val);
            params[cleanKey]=val; raw[cleanKey]=val;
          }
        }
      }
      fetchData(params, raw);
    });

    document.getElementById('clearBtn').addEventListener('click', ()=>{
      document.querySelectorAll('#searchForm input').forEach(i=>i.value='');
      document.getElementById('artformSelect').value = '';
      document.getElementById('artmediumSelect').value = '';
      fetchData({}, {}); // ladda om med standard
    });

    // Knappar i urvalspanelen
    document.getElementById('addAllBtn')?.addEventListener('click', addAllFromCurrentSearch);
    document.getElementById('copyMailSelBtn')?.addEventListener('click', copyThenMaybeEmail);
    document.getElementById('clearSelBtn')?.addEventListener('click', ()=>{
      if (selectionSize() === 0) return;
      if (!confirm('Rensa hela urvalet?')) return;
      selection = {};
      saveSelection();
      updateSelectionUI();
      document.getElementById('selectionDetails')?.removeAttribute('open');
    });

    // ======= Init: dropdowns + auto-sök från URL =======
    populateSelect(document.getElementById('artformSelect'), ART_FORMS, 'konsttyp (alla)');
    populateSelect(document.getElementById('artmediumSelect'), ART_MEDIA, 'teknik (alla)');

    (()=>{
      const urlParams = paramsFromURL();
      // förifyll inputs
      for (const key in urlParams) {
        const el = document.getElementById(inputIdMap[key] || "");
        if (el) el.value = urlParams[key];
      }
      // kör sökning om något finns, annars standard
      if (Object.keys(urlParams).length) {
        fetchData(urlParams, urlParams).then(updateSelectionUI);
      } else {
        fetchData({}, {}).then(updateSelectionUI);
      }
    })();

    // PWA
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('./sw.js')
        .then(r=>console.log('✅ Service worker:', r.scope))
        .catch(err=>console.error('SW-fel:', err));
    }
  </script>
</body>
</html>
